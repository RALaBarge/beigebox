<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BeigeBox — tap the line</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&family=Fira+Code:wght@300;400;500&display=swap');

  /* ── Palette (matches TUI) ───────────────────────────────────────────── */
  :root {
    --lavender:      #B48EAD;
    --lavender-dim:  #7D6080;
    --green:         #A3BE8C;
    --green-dim:     #5C7043;
    --cyan:          #88C0D0;
    --yellow:        #EBCB8B;
    --red:           #BF616A;
    --bg:            #1A1A1A;
    --bg-panel:      #212121;
    --bg-border:     #2E2E2E;
    --bg-hover:      #292929;
    --fg:            #D8DEE9;
    --fg-dim:        #6C7680;
    --fg-muted:      #4C5460;
    --flight-fast:   #a5d6a7;
    --flight-medium: #fff176;
    --flight-slow:   #ffcc80;
    --flight-crit:   #ef9a9a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Fira Code', 'Share Tech Mono', monospace;
    background: var(--bg);
    color: var(--fg);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    font-size: 13px;
  }

  /* ── Header ──────────────────────────────────────────────────────────── */
  #header {
    background: var(--bg-panel);
    border-bottom: 1px solid var(--lavender-dim);
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 40px;
    flex-shrink: 0;
  }
  #header .logo {
    font-family: 'VT323', monospace;
    font-size: 22px;
    color: var(--lavender);
    letter-spacing: 2px;
  }
  #header .sub {
    color: var(--fg-muted);
    font-size: 11px;
    letter-spacing: 1px;
  }
  #header .status-bar {
    display: flex;
    gap: 16px;
    align-items: center;
  }
  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--fg-muted);
    display: inline-block;
    margin-right: 5px;
  }
  .status-dot.ok  { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .status-dot.err { background: var(--red);   box-shadow: 0 0 6px var(--red);   }
  #clock { color: var(--fg-muted); font-size: 11px; }

  /* ── Tabs ────────────────────────────────────────────────────────────── */
  #tabs {
    background: var(--bg-panel);
    border-bottom: 1px solid var(--bg-border);
    display: flex;
    flex-shrink: 0;
  }
  .tab {
    padding: 8px 20px;
    cursor: pointer;
    color: var(--fg-dim);
    border-bottom: 2px solid transparent;
    transition: color 0.15s;
    font-size: 12px;
    letter-spacing: 0.5px;
    user-select: none;
  }
  .tab:hover { color: var(--fg); }
  .tab.active {
    color: var(--lavender);
    border-bottom-color: var(--lavender);
    font-weight: 500;
  }
  .tab .tab-key {
    color: var(--fg-muted);
    font-size: 10px;
    margin-right: 5px;
  }

  /* ── Main content area ───────────────────────────────────────────────── */
  #content {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .panel {
    display: none;
    flex: 1;
    overflow: hidden;
    flex-direction: column;
  }
  .panel.active { display: flex; }

  .scroll-area {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
  }
  .scroll-area::-webkit-scrollbar { width: 4px; }
  .scroll-area::-webkit-scrollbar-track { background: var(--bg); }
  .scroll-area::-webkit-scrollbar-thumb { background: var(--bg-border); border-radius: 2px; }

  /* ── Section headers ─────────────────────────────────────────────────── */
  .section-header {
    color: var(--green);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin: 16px 0 8px;
    border-bottom: 1px solid var(--bg-border);
    padding-bottom: 4px;
  }
  .section-header:first-child { margin-top: 0; }

  /* ── Grid cards ──────────────────────────────────────────────────────── */
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 8px;
    margin-bottom: 12px;
  }
  .card {
    background: var(--bg-panel);
    border: 1px solid var(--bg-border);
    padding: 10px 12px;
    border-radius: 2px;
  }
  .card .card-label { color: var(--fg-muted); font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
  .card .card-value { color: var(--cyan); font-size: 18px; font-family: 'VT323', monospace; }
  .card .card-sub   { color: var(--fg-dim); font-size: 10px; margin-top: 2px; }

  /* ── KV rows ─────────────────────────────────────────────────────────── */
  .kv-row {
    display: flex;
    gap: 8px;
    padding: 3px 0;
    border-bottom: 1px solid var(--bg-border);
    align-items: baseline;
    flex-wrap: wrap;
  }
  .kv-key   { color: var(--cyan);   min-width: 180px; font-size: 12px; }
  .kv-val   { color: var(--fg);     font-size: 12px; word-break: break-all; }
  .kv-ok    { color: var(--green);  }
  .kv-warn  { color: var(--yellow); }
  .kv-err   { color: var(--red);    }
  .kv-dim   { color: var(--fg-dim); }

  /* ── Tag badges ──────────────────────────────────────────────────────── */
  .badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 2px;
    font-size: 10px;
    letter-spacing: 0.5px;
  }
  .badge-ok   { background: var(--green-dim);   color: var(--green);  }
  .badge-warn { background: #3a3000;             color: var(--yellow); }
  .badge-err  { background: #3a1010;             color: var(--red);    }
  .badge-dim  { background: var(--bg-border);    color: var(--fg-dim); }
  .badge-lav  { background: #3a2a3a;             color: var(--lavender); }

  /* ── Refresh btn ─────────────────────────────────────────────────────── */
  .toolbar {
    padding: 6px 16px;
    background: var(--bg-panel);
    border-bottom: 1px solid var(--bg-border);
    display: flex;
    gap: 8px;
    align-items: center;
    flex-shrink: 0;
  }
  button, .btn {
    background: var(--bg-border);
    color: var(--fg-dim);
    border: 1px solid var(--fg-muted);
    padding: 4px 12px;
    cursor: pointer;
    font-family: inherit;
    font-size: 11px;
    letter-spacing: 0.5px;
    border-radius: 2px;
    transition: all 0.15s;
  }
  button:hover, .btn:hover {
    background: var(--bg-hover);
    color: var(--fg);
    border-color: var(--lavender);
  }
  button.primary {
    background: var(--lavender-dim);
    color: var(--bg);
    border-color: var(--lavender);
    font-weight: 500;
  }
  button.primary:hover { background: var(--lavender); }
  button:disabled { opacity: 0.4; cursor: not-allowed; }

  input, select, textarea {
    background: var(--bg);
    color: var(--fg);
    border: 1px solid var(--bg-border);
    padding: 6px 10px;
    font-family: inherit;
    font-size: 12px;
    border-radius: 2px;
    outline: none;
    transition: border-color 0.15s;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--lavender-dim); }
  input::placeholder { color: var(--fg-muted); }

  .toolbar-label { color: var(--fg-dim); font-size: 11px; }
  .toolbar-spacer { flex: 1; }
  .last-updated { color: var(--fg-muted); font-size: 10px; }

  /* ── Status subsystem table ──────────────────────────────────────────── */
  .subsystem-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px 0;
    border-bottom: 1px solid var(--bg-border);
  }
  .subsystem-name { color: var(--fg); min-width: 160px; }
  .subsystem-detail { color: var(--fg-dim); font-size: 11px; flex: 1; }

  /* ── Chat panel ──────────────────────────────────────────────────────── */
  #chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  #chat-messages::-webkit-scrollbar { width: 4px; }
  #chat-messages::-webkit-scrollbar-thumb { background: var(--bg-border); }

  .msg {
    display: flex;
    flex-direction: column;
    max-width: 85%;
    gap: 3px;
  }
  .msg.user   { align-self: flex-end; align-items: flex-end; }
  .msg.assistant { align-self: flex-start; }
  .msg .bubble {
    padding: 8px 12px;
    border-radius: 2px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .msg.user .bubble {
    background: var(--lavender-dim);
    color: var(--bg);
    border-bottom-right-radius: 0;
  }
  .msg.assistant .bubble {
    background: var(--bg-panel);
    border: 1px solid var(--bg-border);
    color: var(--fg);
    border-bottom-left-radius: 0;
  }
  .msg .meta {
    color: var(--fg-muted);
    font-size: 10px;
  }
  .msg.assistant .meta { color: var(--lavender-dim); }

  #chat-input-area {
    padding: 10px 16px;
    background: var(--bg-panel);
    border-top: 1px solid var(--bg-border);
    display: flex;
    gap: 8px;
    align-items: flex-end;
    flex-shrink: 0;
  }
  #chat-input {
    flex: 1;
    resize: none;
    min-height: 38px;
    max-height: 120px;
    line-height: 1.5;
    padding: 8px 10px;
  }
  #model-select { min-width: 180px; height: 38px; }

  .typing-indicator {
    display: flex; gap: 4px; align-items: center; padding: 8px 12px;
    background: var(--bg-panel); border: 1px solid var(--bg-border);
    border-radius: 2px; align-self: flex-start;
  }
  .typing-indicator span {
    width: 5px; height: 5px; border-radius: 50%;
    background: var(--lavender-dim);
    animation: blink 1.2s infinite;
  }
  .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink { 0%,80%,100%{opacity:0.2} 40%{opacity:1} }

  .z-hint {
    color: var(--fg-muted); font-size: 10px; padding: 2px 16px;
    background: var(--bg-panel); border-top: 1px solid var(--bg-border);
    flex-shrink: 0;
  }

  /* ── Flight recorder ─────────────────────────────────────────────────── */
  .flight-record {
    background: var(--bg-panel);
    border: 1px solid var(--bg-border);
    margin-bottom: 8px;
    border-radius: 2px;
    overflow: hidden;
  }
  .flight-header {
    padding: 6px 12px;
    display: flex;
    gap: 12px;
    align-items: center;
    cursor: pointer;
    user-select: none;
    border-bottom: 1px solid var(--bg-border);
  }
  .flight-header:hover { background: var(--bg-hover); }
  .flight-id-text { color: var(--lavender); font-size: 12px; }
  .flight-model-text { color: #ce93d8; font-size: 11px; }
  .flight-total { font-family: 'VT323', monospace; font-size: 16px; }
  .flight-total.fast   { color: var(--flight-fast); }
  .flight-total.medium { color: var(--flight-medium); }
  .flight-total.slow   { color: var(--flight-slow); }
  .flight-total.crit   { color: var(--flight-crit); }
  .flight-events { padding: 8px 12px; display: none; }
  .flight-record.expanded .flight-events { display: block; }
  .flight-event {
    display: flex; gap: 12px; padding: 2px 0;
    border-bottom: 1px solid var(--bg-border); font-size: 11px;
  }
  .flight-event-ms  { color: var(--fg-muted); min-width: 80px; text-align: right; }
  .flight-event-stage { color: var(--fg); }
  .flight-event-detail { color: var(--fg-dim); font-size: 10px; }
  .flight-bar-row {
    display: flex; gap: 8px; align-items: center;
    padding: 2px 0; font-size: 10px;
  }
  .flight-bar-label { color: var(--fg-muted); min-width: 160px; }
  .flight-bar-track {
    flex: 1; height: 6px; background: var(--bg-border); border-radius: 1px; overflow: hidden;
  }
  .flight-bar-fill { height: 100%; border-radius: 1px; }
  .flight-bar-ms { color: var(--fg-dim); min-width: 70px; text-align: right; }

  /* ── Conversations ────────────────────────────────────────────────────── */
  .conv-row {
    padding: 6px 10px;
    border-bottom: 1px solid var(--bg-border);
    cursor: pointer;
    display: flex;
    gap: 10px;
    align-items: baseline;
  }
  .conv-row:hover { background: var(--bg-hover); }
  .conv-id   { color: var(--lavender); font-size: 11px; min-width: 130px; }
  .conv-preview { color: var(--fg-dim); font-size: 11px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .conv-meta { color: var(--fg-muted); font-size: 10px; }
  .conv-score { color: var(--yellow); font-size: 10px; min-width: 50px; text-align: right; }

  /* ── Operator ────────────────────────────────────────────────────────── */
  #op-log {
    flex: 1; overflow-y: auto; padding: 12px 16px; font-size: 12px; line-height: 1.6;
  }
  #op-log::-webkit-scrollbar { width: 4px; }
  #op-log::-webkit-scrollbar-thumb { background: var(--bg-border); }
  .op-query   { color: var(--cyan);    margin-bottom: 4px; }
  .op-answer  { color: var(--fg);      white-space: pre-wrap; word-break: break-word; margin-bottom: 12px; }
  .op-error   { color: var(--red);     margin-bottom: 12px; }
  .op-pending { color: var(--yellow);  font-style: italic; }
  .op-sep { border-top: 1px solid var(--bg-border); margin: 8px 0; }
  #op-input-area {
    padding: 10px 16px; background: var(--bg-panel);
    border-top: 1px solid var(--bg-border);
    display: flex; gap: 8px; flex-shrink: 0;
  }
  #op-input { flex: 1; }

  /* ── Spinner ─────────────────────────────────────────────────────────── */
  .spinner {
    display: inline-block; width: 10px; height: 10px;
    border: 2px solid var(--bg-border);
    border-top-color: var(--lavender);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── π Vi mode toggle ───────────────────────────────────────────────── */
  #vi-toggle {
    position: fixed;
    bottom: 10px;
    left: 14px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--bg-panel);
    border: 1px solid var(--bg-border);
    color: var(--fg-muted);
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9998;
    transition: all 0.2s;
    user-select: none;
  }
  #vi-toggle:hover { border-color: var(--lavender); color: var(--lavender); }
  #vi-toggle.active {
    background: var(--lavender-dim);
    border-color: var(--lavender);
    color: var(--bg);
    box-shadow: 0 0 8px var(--lavender-dim);
  }
  #vi-toggle .tooltip {
    display: none;
    position: absolute;
    left: 30px;
    bottom: 0;
    background: var(--bg-panel);
    border: 1px solid var(--bg-border);
    color: var(--fg-dim);
    font-size: 10px;
    padding: 2px 6px;
    white-space: nowrap;
    border-radius: 2px;
    pointer-events: none;
  }
  #vi-toggle:hover .tooltip { display: block; }

  /* ── Cost charts ─────────────────────────────────────────────────────── */
  .chart-wrap {
    background: var(--bg-panel);
    border: 1px solid var(--bg-border);
    border-radius: 2px;
    padding: 10px 12px;
    margin-bottom: 10px;
  }
  .chart-title {
    color: var(--fg-muted);
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }
  canvas.bb-chart {
    display: block;
    width: 100%;
    image-rendering: pixelated;
  }
  .cost-disabled {
    color: var(--fg-muted);
    font-size: 11px;
    padding: 8px 0 4px;
  }

  /* ── Misc ────────────────────────────────────────────────────────────── */
  .empty { color: var(--fg-muted); padding: 20px; text-align: center; font-size: 12px; }
  .error-box {
    background: #2a1010; border: 1px solid var(--red);
    color: var(--red); padding: 8px 12px; border-radius: 2px; margin: 8px 0; font-size: 11px;
  }
  code {
    background: var(--bg-border); padding: 1px 5px; border-radius: 2px;
    font-family: 'Fira Code', monospace; font-size: 11px; color: var(--cyan);
  }
  .mono { font-family: 'VT323', monospace; }
  hr { border: none; border-top: 1px solid var(--bg-border); margin: 8px 0; }
</style>
</head>
<body>

<!-- ── Header ──────────────────────────────────────────────────────────── -->
<div id="header">
  <div>
    <span class="logo">BeigeBox</span>
    <span class="sub" style="margin-left:12px">tap the line · control the carrier</span>
  </div>
  <div class="status-bar">
    <span><span class="status-dot" id="proxy-dot"></span><span id="proxy-status" style="font-size:11px;color:var(--fg-dim)">connecting…</span></span>
    <span id="clock"></span>
  </div>
</div>

<!-- ── Tabs ────────────────────────────────────────────────────────────── -->
<div id="tabs">
  <div class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')"><span class="tab-key">1</span>Dashboard</div>
  <div class="tab" data-tab="chat"      onclick="switchTab('chat')">     <span class="tab-key">2</span>Chat</div>
  <div class="tab" data-tab="convos"    onclick="switchTab('convos')">   <span class="tab-key">3</span>Conversations</div>
  <div class="tab" data-tab="flight"    onclick="switchTab('flight')">   <span class="tab-key">4</span>Flight Recorder</div>
  <div class="tab" data-tab="tap"       onclick="switchTab('tap')">      <span class="tab-key">5</span>Tap</div>
  <div class="tab" data-tab="operator"  onclick="switchTab('operator')"> <span class="tab-key">6</span>Operator</div>
  <div class="tab" data-tab="config"    onclick="switchTab('config')">   <span class="tab-key">7</span>Config</div>
</div>

<!-- ── Content ─────────────────────────────────────────────────────────── -->
<div id="content">

  <!-- 1. Dashboard -->
  <div class="panel active" id="panel-dashboard">
    <div class="toolbar">
      <button onclick="loadDashboard()">↺ Refresh</button>
      <span class="toolbar-spacer"></span>
      <span class="last-updated" id="dash-updated"></span>
    </div>
    <div class="scroll-area" id="dash-body">
      <div class="empty">Loading…</div>
    </div>
  </div>

  <!-- 2. Chat -->
  <div class="panel" id="panel-chat">
    <div class="toolbar">
      <span class="toolbar-label">Model:</span>
      <select id="model-select" onchange="saveModel()"><option value="">default</option></select>
      <button onclick="clearChat()" style="margin-left:auto">✕ Clear</button>
    </div>
    <div id="chat-messages"></div>
    <div class="z-hint">z-commands: <code>z: search</code> <code>z: code</code> <code>z: complex</code> <code>z: help</code> — prefix your message</div>
    <div id="chat-input-area">
      <textarea id="chat-input" placeholder="Send a message… (Enter to send, Shift+Enter for newline)" rows="1"
        onkeydown="chatKeydown(event)" oninput="autoResize(this)"></textarea>
      <button class="primary" onclick="sendChat()" id="send-btn">Send</button>
    </div>
  </div>

  <!-- 3. Conversations -->
  <div class="panel" id="panel-convos">
    <div class="toolbar">
      <input id="search-input" placeholder="Semantic search…" style="width:300px"
        onkeydown="if(event.key==='Enter')searchConvos()">
      <button onclick="searchConvos()">Search</button>
      <span class="toolbar-spacer"></span>
      <span class="toolbar-label" id="search-status"></span>
    </div>
    <div class="scroll-area" id="convos-body">
      <div class="empty">Enter a search query above to search conversations semantically.</div>
    </div>
  </div>

  <!-- 4. Flight Recorder -->
  <div class="panel" id="panel-flight">
    <div class="toolbar">
      <button onclick="loadFlight()">↺ Refresh</button>
      <span class="toolbar-label" style="margin-left:8px">Count:</span>
      <input id="flight-n" type="number" value="20" min="1" max="100" style="width:60px">
      <span class="toolbar-spacer"></span>
      <span class="last-updated" id="flight-updated"></span>
    </div>
    <div class="scroll-area" id="flight-body">
      <div class="empty">Loading…</div>
    </div>
  </div>

  <!-- 5. Tap -->
  <div class="panel" id="panel-tap">
    <div class="toolbar">
      <button onclick="loadTap()">↺ Refresh</button>
      <span class="toolbar-label" style="margin-left:8px">Role:</span>
      <select id="tap-role" onchange="loadTap()" style="width:110px">
        <option value="">all</option>
        <option value="user">user</option>
        <option value="assistant">assistant</option>
        <option value="system">system</option>
        <option value="decision">decision</option>
        <option value="tool">tool</option>
      </select>
      <span class="toolbar-label" style="margin-left:8px">Direction:</span>
      <select id="tap-dir" onchange="loadTap()" style="width:110px">
        <option value="">all</option>
        <option value="inbound">inbound</option>
        <option value="outbound">outbound</option>
        <option value="internal">internal</option>
      </select>
      <span class="toolbar-label" style="margin-left:8px">Lines:</span>
      <input id="tap-n" type="number" value="50" min="10" max="500" style="width:60px" onchange="loadTap()">
      <label style="margin-left:8px;color:var(--fg-dim);font-size:11px;cursor:pointer">
        <input type="checkbox" id="tap-live" onchange="toggleTapLive()"> live
      </label>
      <span class="toolbar-spacer"></span>
      <span class="last-updated" id="tap-updated"></span>
    </div>
    <div class="scroll-area" id="tap-body" style="font-size:11px;line-height:1.6">
      <div class="empty">Loading…</div>
    </div>
  </div>

  <!-- 6. Operator -->
  <div class="panel" id="panel-operator">
    <div class="toolbar">
      <span class="toolbar-label">Operator Agent — LangChain ReAct · web search · conversation memory · shell</span>
      <span class="toolbar-spacer"></span>
      <button onclick="clearOp()">✕ Clear</button>
    </div>
    <div id="op-log"></div>
    <div id="op-input-area">
      <input id="op-input" placeholder="Ask the operator anything…"
        onkeydown="if(event.key==='Enter')runOp()">
      <button class="primary" onclick="runOp()" id="op-btn">Run</button>
    </div>
  </div>

  <!-- 6. Config -->
  <div class="panel" id="panel-config">
    <div class="toolbar">
      <button onclick="loadConfig()">↺ Refresh</button>
      <span class="toolbar-spacer"></span>
      <span class="last-updated" id="config-updated"></span>
    </div>
    <div class="scroll-area" id="config-body">
      <div class="empty">Loading…</div>
    </div>
  </div>

</div>

<!-- ── Vi mode toggle ───────────────────────────────────────────────────── -->
<div id="vi-toggle" onclick="toggleViMode()" title="">
  π
  <span class="tooltip" id="vi-tooltip">vi mode: off</span>
</div>

<script>
// ── State ───────────────────────────────────────────────────────────────────
const BASE = '';  // same origin
let chatHistory = [];
let currentModel = localStorage.getItem('bb_model') || '';
let viModeActive = false;

// Persist and restore chat history across tab switches
function saveChatHistory() {
  try { localStorage.setItem('bb_chat_history', JSON.stringify(chatHistory)); } catch {}
}
function restoreChatHistory() {
  try {
    const saved = localStorage.getItem('bb_chat_history');
    if (saved) chatHistory = JSON.parse(saved);
  } catch {}
}

// ── Palette themes ──────────────────────────────────────────────────────────
const THEMES = {
  default: {
    '--lavender':      '#B48EAD',
    '--lavender-dim':  '#7D6080',
    '--green':         '#A3BE8C',
    '--green-dim':     '#5C7043',
    '--cyan':          '#88C0D0',
    '--yellow':        '#EBCB8B',
    '--red':           '#BF616A',
  },
  dracula: {
    '--lavender':      '#BD93F9',
    '--lavender-dim':  '#6272A4',
    '--green':         '#50FA7B',
    '--green-dim':     '#2A7A40',
    '--cyan':          '#8BE9FD',
    '--yellow':        '#F1FA8C',
    '--red':           '#FF5555',
  },
  gruvbox: {
    '--lavender':      '#D3869B',
    '--lavender-dim':  '#8F5070',
    '--green':         '#B8BB26',
    '--green-dim':     '#636700',
    '--cyan':          '#8EC07C',
    '--yellow':        '#FABD2F',
    '--red':           '#FB4934',
  },
  nord: {
    '--lavender':      '#B48EAD',
    '--lavender-dim':  '#6B5272',
    '--green':         '#A3BE8C',
    '--green-dim':     '#4E6A35',
    '--cyan':          '#88C0D0',
    '--yellow':        '#EBCB8B',
    '--red':           '#BF616A',
  },
};

function randomPalette() {
  // Random hue, saturation 40-60%, lightness 55-75% for accents
  // Derive dim/muted variants by dropping lightness ~25%
  const hue = Math.floor(Math.random() * 360);
  const hue2 = (hue + 137) % 360;  // complementary-ish secondary
  const hue3 = (hue + 60)  % 360;  // triad for cyan
  const hue4 = (hue + 180) % 360;  // contrast for red

  const sat  = 40 + Math.floor(Math.random() * 20); // 40–60
  const lit  = 55 + Math.floor(Math.random() * 20); // 55–75
  const litD = lit - 25;                             // dim variant

  return {
    '--lavender':     `hsl(${hue},  ${sat}%, ${lit}%)`,
    '--lavender-dim': `hsl(${hue},  ${sat}%, ${litD}%)`,
    '--green':        `hsl(${hue2}, ${sat}%, ${lit}%)`,
    '--green-dim':    `hsl(${hue2}, ${sat}%, ${litD}%)`,
    '--cyan':         `hsl(${hue3}, ${sat}%, ${lit}%)`,
    '--yellow':       `hsl(45,      60%,     ${lit}%)`,
    '--red':          `hsl(${hue4}, 55%,     ${lit - 5}%)`,
  };
}

function applyPalette(name) {
  const root = document.documentElement;
  const vars = name === 'random' ? randomPalette() : (THEMES[name] || THEMES.default);
  Object.entries(vars).forEach(([prop, val]) => root.style.setProperty(prop, val));
}

// ── Vi mode ─────────────────────────────────────────────────────────────────
function setViToggleState(active) {
  viModeActive = active;
  const btn = document.getElementById('vi-toggle');
  const tip = document.getElementById('vi-tooltip');
  btn.classList.toggle('active', active);
  if (tip) tip.textContent = `vi mode: ${active ? 'on' : 'off'}`;
}

function injectViMode() {
  if (document.getElementById('vi-script')) return;
  const s = document.createElement('script');
  s.id  = 'vi-script';
  s.src = '/web/vi.js';
  document.body.appendChild(s);
}

function removeViMode() {
  const s = document.getElementById('vi-script');
  if (s) s.remove();
  const ind = document.getElementById('vi-indicator');
  if (ind) ind.remove();
}

async function toggleViMode() {
  try {
    const d = await api('/api/v1/web-ui/toggle-vi-mode', { method: 'POST' });
    setViToggleState(d.vi_mode);
    if (d.vi_mode) injectViMode(); else removeViMode();
  } catch(e) {
    console.error('vi mode toggle failed:', e);
  }
}

// ── Clock ───────────────────────────────────────────────────────────────────
function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString();
}
setInterval(updateClock, 1000);
updateClock();

// ── Tab switching ───────────────────────────────────────────────────────────
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + name));
  if (name === 'dashboard') loadDashboard();
  if (name === 'flight')    loadFlight();
  if (name === 'tap')       loadTap();
  if (name === 'config')    loadConfig();
  if (name === 'chat')      loadModels();
}

document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  const map = {'1':'dashboard','2':'chat','3':'convos','4':'flight','5':'tap','6':'operator','7':'config'};
  if (map[e.key]) switchTab(map[e.key]);
});

// ── API helpers ─────────────────────────────────────────────────────────────
async function api(path, opts={}) {
  const r = await fetch(BASE + path, opts);
  if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}

function fmtTs(iso) {
  if (!iso) return '';
  try { return new Date(iso).toLocaleTimeString(); } catch { return iso; }
}

function badge(ok, yes='enabled', no='disabled') {
  return ok
    ? `<span class="badge badge-ok">${yes}</span>`
    : `<span class="badge badge-dim">${no}</span>`;
}

function kv(key, val, cls='') {
  const valCls = cls ? `kv-${cls}` : '';
  return `<div class="kv-row"><span class="kv-key">${esc(key)}</span><span class="kv-val ${valCls}">${val}</span></div>`;
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function latencyClass(ms) {
  if (ms < 100)  return 'fast';
  if (ms < 500)  return 'medium';
  if (ms < 2000) return 'slow';
  return 'crit';
}

// ── Health polling ───────────────────────────────────────────────────────────
async function pollHealth() {
  try {
    const d = await api('/beigebox/health');
    document.getElementById('proxy-dot').className = 'status-dot ok';
    document.getElementById('proxy-status').textContent = `v${d.version}`;
  } catch {
    document.getElementById('proxy-dot').className = 'status-dot err';
    document.getElementById('proxy-status').textContent = 'offline';
  }
}
pollHealth();
setInterval(pollHealth, 10000);

// ── 1. Dashboard ─────────────────────────────────────────────────────────────
async function loadDashboard() {
  const el = document.getElementById('dash-body');
  el.innerHTML = '<div class="empty"><span class="spinner"></span> Loading…</div>';
  try {
    const [status, stats, backends, info, costs, perf] = await Promise.allSettled([
      api('/api/v1/status'),
      api('/api/v1/stats'),
      api('/api/v1/backends'),
      api('/api/v1/info'),
      api('/api/v1/costs?days=30'),
      api('/api/v1/model-performance?days=30'),
    ]);

    let html = '';

    // ── Stat cards ──
    const s = stats.status === 'fulfilled' ? stats.value : {};
    const convs = s.conversations || {};
    html += '<div class="card-grid">';
    html += card('Conversations', convs.total_conversations ?? '—', 'stored in sqlite');
    html += card('Messages',      convs.total_messages ?? '—',       'across all convos');
    html += card('Avg Length',    convs.avg_messages_per_conversation != null
      ? Number(convs.avg_messages_per_conversation).toFixed(1) : '—', 'messages/convo');
    const emb = s.embeddings || {};
    html += card('Embeddings',    emb.total_embeddings ?? '—', 'in chromadb');
    html += '</div>';

    // ── Subsystems ──
    const st = status.status === 'fulfilled' ? status.value : {};
    html += '<div class="section-header">Subsystems</div>';
    if (st.proxy) {
      html += subsystem('Proxy',              true,                   `backend: ${esc(st.proxy.backend_url || '—')}`);
      html += subsystem('Storage · SQLite',   st.storage?.sqlite,     st.storage?.stats ? `${st.storage.stats.total_messages ?? 0} messages` : '');
      html += subsystem('Storage · ChromaDB', st.storage?.vector,     '');
      html += subsystem('Decision LLM',       st.routing?.decision_llm?.enabled, st.routing?.decision_llm?.model ? `model: ${esc(st.routing.decision_llm.model)}` : 'disabled');
      html += subsystem('Embedding Classifier', st.routing?.embedding_classifier?.ready, '');
      html += subsystem('Tools',              st.tools?.enabled,      st.tools?.available?.join(', ') || '');
    } else {
      html += '<div class="error-box" style="background:transparent;border-color:var(--fg-muted);color:var(--fg-muted)">No subsystems loaded — proxy may still be starting up.</div>';
    }

    // ── Backends ──
    const bk = backends.status === 'fulfilled' ? backends.value : {};
    html += '<div class="section-header">Backends</div>';
    if (bk.enabled) {
      (bk.backends || []).forEach(b => {
        html += subsystem(
          `${esc(b.name)} <span class="badge badge-dim">${esc(b.provider)}</span>`,
          b.healthy,
          `priority ${b.priority} · ${b.url}`
        );
      });
    } else {
      const inf = info.status === 'fulfilled' ? info.value : {};
      html += subsystem('Primary Backend', true, esc(inf.backend?.url || bk.primary_backend || '—'));
      html += `<div style="color:var(--fg-muted);font-size:11px;padding:4px 0">Multi-backend routing disabled (backends_enabled: false)</div>`;
    }

    // ── Info ──
    const i = info.status === 'fulfilled' ? info.value : {};
    if (i.version) {
      html += '<div class="section-header">Info</div>';
      html += kv('version',          esc(i.version));
      html += kv('default_model',    esc(i.backend?.default_model || '—'));
      html += kv('model_advertising',esc(i.model_advertising || '—'));
      html += kv('server',           `${esc(i.server?.host || '0.0.0.0')}:${i.server?.port || 8000}`);
    }

    // ── Cost tracking ──
    const c30 = costs.status === 'fulfilled' ? costs.value : null;
    html += '<div class="section-header">Cost Tracking · 30 days</div>';
    if (!c30 || !c30.enabled) {
      html += '<div class="cost-disabled">Cost tracking is disabled. Set <code>cost_tracking.enabled: true</code> in config.yaml.</div>';
    } else {
      // Summary cards
      html += '<div class="card-grid">';
      html += card('Total Spend', '$' + (c30.total || 0).toFixed(4), '30-day period');
      html += card('Daily Avg',   '$' + (c30.average_daily || 0).toFixed(4), 'per day');
      const modelCount = Object.keys(c30.by_model || {}).length;
      html += card('API Models', modelCount, 'tracked models');
      html += '</div>';
      // Charts placeholder — rendered after innerHTML is set
      html += '<div class="chart-wrap"><div class="chart-title">Spend by Day</div><canvas class="bb-chart" id="chart-day" height="90"></canvas></div>';
      html += '<div class="chart-wrap"><div class="chart-title">Spend by Model</div><canvas class="bb-chart" id="chart-model" height="' + Math.max(60, modelCount * 28) + '"></canvas></div>';
    }

    // ── Model Performance ──
    const perfData = perf.status === 'fulfilled' ? perf.value : null;
    html += '<div class="section-header">Model Performance · 30 days</div>';
    if (!perfData || !perfData.enabled || !Object.keys(perfData.by_model || {}).length) {
      html += '<div class="cost-disabled">No latency data yet — recorded on non-streaming requests via the multi-backend router.</div>';
    } else {
      html += '<div class="chart-wrap"><div class="chart-title">Avg Latency by Model (ms)</div><canvas class="bb-chart" id="chart-latency" height="' + Math.max(60, Object.keys(perfData.by_model).length * 28) + '"></canvas></div>';
      // Stats table
      html += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px">';
      html += '<tr style="color:var(--fg-muted);border-bottom:1px solid var(--bg-border)">';
      html += '<th style="text-align:left;padding:3px 8px">Model</th><th style="padding:3px 8px">Reqs</th><th style="padding:3px 8px">Avg ms</th><th style="padding:3px 8px">p50 ms</th><th style="padding:3px 8px">p95 ms</th><th style="padding:3px 8px">Avg tok</th><th style="padding:3px 8px">Cost</th></tr>';
      Object.entries(perfData.by_model).forEach(([name, m]) => {
        const p95cls = m.p95_latency_ms > 5000 ? 'color:var(--red)' : m.p95_latency_ms > 2000 ? 'color:var(--yellow)' : 'color:var(--green)';
        html += `<tr style="border-bottom:1px solid var(--bg-border)">
          <td style="padding:3px 8px;color:var(--fg)">${esc(name)}</td>
          <td style="padding:3px 8px;color:var(--cyan);text-align:center">${m.requests}</td>
          <td style="padding:3px 8px;color:var(--fg-dim);text-align:center">${m.avg_latency_ms}</td>
          <td style="padding:3px 8px;color:var(--fg-dim);text-align:center">${m.p50_latency_ms}</td>
          <td style="padding:3px 8px;text-align:center;${p95cls}">${m.p95_latency_ms}</td>
          <td style="padding:3px 8px;color:var(--fg-muted);text-align:center">${m.avg_tokens}</td>
          <td style="padding:3px 8px;color:var(--fg-muted);text-align:center">$${m.total_cost_usd.toFixed(4)}</td>
        </tr>`;
      });
      html += '</table></div>';
    }

    document.getElementById('dash-updated').textContent = 'updated ' + new Date().toLocaleTimeString();
    el.innerHTML = html;

    // Render charts after DOM is ready
    if (c30?.enabled) {
      renderDayChart(c30.by_day || {});
      renderModelChart(c30.by_model || {});
    }
    if (perfData?.enabled && Object.keys(perfData.by_model || {}).length) {
      renderLatencyChart(perfData.by_model || {});
    }
  } catch(e) {
    el.innerHTML = `<div class="error-box">Failed to load dashboard: ${esc(e.message)}</div>`;
  }
}

// ── Cost chart renderers ──────────────────────────────────────────────────────

function renderDayChart(byDay) {
  const canvas = document.getElementById('chart-day');
  if (!canvas) return;

  // Sort last 30 days chronologically, fill gaps with 0
  const today = new Date();
  const labels = [];
  const values = [];
  for (let i = 29; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(today.getDate() - i);
    const key = d.toISOString().slice(0, 10);
    labels.push(key.slice(5));   // MM-DD
    values.push(byDay[key] || 0);
  }

  const maxVal = Math.max(...values, 0.000001);
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 600;
  const H = parseInt(canvas.getAttribute('height')) || 90;
  canvas.width  = W * dpr;
  canvas.height = H * dpr;
  canvas.style.height = H + 'px';

  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const PAD_L = 52, PAD_R = 8, PAD_T = 8, PAD_B = 22;
  const chartW = W - PAD_L - PAD_R;
  const chartH = H - PAD_T - PAD_B;
  const barW   = Math.max(2, chartW / labels.length - 2);
  const gap    = chartW / labels.length;

  // Grid lines
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-border').trim() || '#2E2E2E';
  ctx.lineWidth = 1;
  for (let g = 0; g <= 4; g++) {
    const y = PAD_T + chartH - (g / 4) * chartH;
    ctx.beginPath(); ctx.moveTo(PAD_L, y); ctx.lineTo(PAD_L + chartW, y); ctx.stroke();
    if (g > 0) {
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg-muted').trim() || '#4C5460';
      ctx.font = '9px monospace';
      ctx.textAlign = 'right';
      ctx.fillText('$' + ((maxVal * g / 4)).toFixed(4), PAD_L - 4, y + 3);
    }
  }

  // Bars
  const barColor = getComputedStyle(document.documentElement).getPropertyValue('--lavender').trim() || '#B48EAD';
  values.forEach((v, i) => {
    const x = PAD_L + i * gap + (gap - barW) / 2;
    const barH = (v / maxVal) * chartH;
    const y = PAD_T + chartH - barH;
    ctx.fillStyle = v > 0 ? barColor : '#2E2E2E';
    ctx.fillRect(x, y, barW, barH);
  });

  // X-axis labels — show every 7th
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg-muted').trim() || '#4C5460';
  ctx.font = '9px monospace';
  ctx.textAlign = 'center';
  labels.forEach((lbl, i) => {
    if (i % 7 === 0 || i === labels.length - 1) {
      const x = PAD_L + i * gap + gap / 2;
      ctx.fillText(lbl, x, H - 4);
    }
  });
}

function renderModelChart(byModel) {
  const canvas = document.getElementById('chart-model');
  if (!canvas) return;

  const entries = Object.entries(byModel)
    .map(([name, info]) => ({ name, cost: info.cost || 0, msgs: info.messages || 0 }))
    .sort((a, b) => b.cost - a.cost)
    .slice(0, 10);

  if (!entries.length) {
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg-muted').trim();
    ctx.font = '11px monospace';
    ctx.fillText('No cost data recorded yet.', 10, 20);
    return;
  }

  const maxVal = Math.max(...entries.map(e => e.cost), 0.000001);
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 600;
  const ROW_H = 24;
  const PAD_L = 160, PAD_R = 70, PAD_T = 6, PAD_B = 6;
  const H = PAD_T + entries.length * ROW_H + PAD_B;
  canvas.height = H;
  canvas.style.height = H + 'px';
  canvas.width  = W * dpr;
  canvas.height = H * dpr;
  canvas.style.height = H + 'px';

  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const chartW = W - PAD_L - PAD_R;
  const barColor  = getComputedStyle(document.documentElement).getPropertyValue('--cyan').trim() || '#88C0D0';
  const labelColor = getComputedStyle(document.documentElement).getPropertyValue('--fg-dim').trim() || '#6C7680';
  const valColor   = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim() || '#D8DEE9';

  entries.forEach((e, i) => {
    const y = PAD_T + i * ROW_H;
    const barH = ROW_H - 6;
    const barW = (e.cost / maxVal) * chartW;

    // Model name label
    ctx.fillStyle = labelColor;
    ctx.font = '10px monospace';
    ctx.textAlign = 'right';
    const shortName = e.name.length > 22 ? '…' + e.name.slice(-20) : e.name;
    ctx.fillText(shortName, PAD_L - 6, y + barH - 4);

    // Bar
    ctx.fillStyle = barColor;
    ctx.fillRect(PAD_L, y + 3, Math.max(barW, 1), barH);

    // Cost label
    ctx.fillStyle = valColor;
    ctx.textAlign = 'left';
    ctx.font = '10px monospace';
    ctx.fillText('$' + e.cost.toFixed(4) + ' · ' + e.msgs + 'msg', PAD_L + Math.max(barW, 1) + 6, y + barH - 4);
  });
}

function renderLatencyChart(byModel) {
  const canvas = document.getElementById('chart-latency');
  if (!canvas) return;

  const entries = Object.entries(byModel)
    .map(([name, m]) => ({ name, avg: m.avg_latency_ms, p50: m.p50_latency_ms, p95: m.p95_latency_ms }))
    .sort((a, b) => b.avg - a.avg)
    .slice(0, 10);

  if (!entries.length) return;

  const maxVal = Math.max(...entries.map(e => e.p95), 1);
  const dpr  = window.devicePixelRatio || 1;
  const W    = canvas.offsetWidth || canvas.parentElement.offsetWidth || 600;
  const ROW_H = 24;
  const PAD_L = 160, PAD_R = 80, PAD_T = 6, PAD_B = 6;
  const H = PAD_T + entries.length * ROW_H + PAD_B;
  canvas.width  = W * dpr;
  canvas.height = H * dpr;
  canvas.style.height = H + 'px';

  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const chartW = W - PAD_L - PAD_R;
  const avgColor = getComputedStyle(document.documentElement).getPropertyValue('--cyan').trim()    || '#88C0D0';
  const p95Color = getComputedStyle(document.documentElement).getPropertyValue('--yellow').trim()  || '#EBCB8B';
  const labelColor= getComputedStyle(document.documentElement).getPropertyValue('--fg-dim').trim() || '#6C7680';
  const valColor  = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim()     || '#D8DEE9';

  entries.forEach((e, i) => {
    const y = PAD_T + i * ROW_H;
    const barH = ROW_H - 8;

    // Label
    ctx.fillStyle = labelColor;
    ctx.font = '10px monospace';
    ctx.textAlign = 'right';
    const shortName = e.name.length > 22 ? '…' + e.name.slice(-20) : e.name;
    ctx.fillText(shortName, PAD_L - 6, y + barH);

    // p95 bar (background, wider)
    const p95W = (e.p95 / maxVal) * chartW;
    ctx.fillStyle = p95Color + '55';
    ctx.fillRect(PAD_L, y + 2, Math.max(p95W, 1), barH);

    // avg bar (foreground)
    const avgW = (e.avg / maxVal) * chartW;
    ctx.fillStyle = avgColor;
    ctx.fillRect(PAD_L, y + 2, Math.max(avgW, 1), barH);

    // Value label
    ctx.fillStyle = valColor;
    ctx.textAlign = 'left';
    ctx.font = '10px monospace';
    ctx.fillText(`${e.avg}ms avg  p95:${e.p95}ms`, PAD_L + Math.max(p95W, 1) + 6, y + barH);
  });
}

function card(label, value, sub) {
  return `<div class="card"><div class="card-label">${esc(label)}</div><div class="card-value">${esc(String(value))}</div><div class="card-sub">${esc(sub)}</div></div>`;
}

function subsystem(name, ok, detail) {
  const dot = `<span class="status-dot ${ok ? 'ok' : 'err'}" style="display:inline-block;vertical-align:middle;margin-right:6px"></span>`;
  return `<div class="subsystem-row">${dot}<span class="subsystem-name">${name}</span><span class="subsystem-detail">${esc(detail)}</span></div>`;
}

// ── 2. Chat ──────────────────────────────────────────────────────────────────
async function loadModels() {
  try {
    const d = await api('/v1/models');
    const sel = document.getElementById('model-select');
    const cur = currentModel;
    sel.innerHTML = '<option value="">— default —</option>';
    (d.data || d.models || []).forEach(m => {
      const id = m.id || m.name || m;
      const opt = document.createElement('option');
      opt.value = id; opt.textContent = id;
      if (id === cur) opt.selected = true;
      sel.appendChild(opt);
    });
  } catch {}
}

function saveModel() {
  currentModel = document.getElementById('model-select').value;
  localStorage.setItem('bb_model', currentModel);
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function chatKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
}

function clearChat() {
  chatHistory = [];
  localStorage.removeItem('bb_chat_history');
  document.getElementById('chat-messages').innerHTML = '';
}

async function sendChat() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  input.style.height = 'auto';

  const model = document.getElementById('model-select').value;
  appendMsg('user', text, model || 'default');
  chatHistory.push({ role: 'user', content: text });
  saveChatHistory();

  const sendBtn = document.getElementById('send-btn');
  sendBtn.disabled = true;

  // Typing indicator
  const typingId = 'typing-' + Date.now();
  const msgDiv = document.getElementById('chat-messages');
  msgDiv.insertAdjacentHTML('beforeend',
    `<div class="typing-indicator" id="${typingId}"><span></span><span></span><span></span></div>`);
  msgDiv.scrollTop = msgDiv.scrollHeight;

  try {
    const body = { messages: chatHistory, stream: true };
    if (model) body.model = model;

    const resp = await fetch(BASE + '/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer beigebox' },
      body: JSON.stringify(body),
    });

    document.getElementById(typingId)?.remove();

    if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let fullText = '';
    let assistantDiv = null;
    let bubble = null;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value);
      for (const line of chunk.split('\n')) {
        if (!line.startsWith('data: ')) continue;
        const data = line.slice(6).trim();
        if (data === '[DONE]') break;
        try {
          const j = JSON.parse(data);
          const delta = j.choices?.[0]?.delta?.content || '';
          if (delta) {
            fullText += delta;
            if (!assistantDiv) {
              const usedModel = j.model || model || 'assistant';
              assistantDiv = appendMsg('assistant', '', usedModel);
              bubble = assistantDiv.querySelector('.bubble');
            }
            if (bubble) bubble.textContent = fullText;
            msgDiv.scrollTop = msgDiv.scrollHeight;
          }
        } catch {}
      }
    }

    if (fullText) {
      chatHistory.push({ role: 'assistant', content: fullText });
      saveChatHistory();
    }

  } catch(e) {
    document.getElementById(typingId)?.remove();
    appendMsg('assistant', `Error: ${e.message}`, 'error');
  }

  sendBtn.disabled = false;
  input.focus();
}

function appendMsg(role, text, model) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = `
    <div class="meta">${esc(role === 'user' ? 'you' : model)} · ${new Date().toLocaleTimeString()}</div>
    <div class="bubble">${esc(text)}</div>`;
  document.getElementById('chat-messages').appendChild(div);
  document.getElementById('chat-messages').scrollTop = 999999;
  return div;
}

// ── 3. Conversations ─────────────────────────────────────────────────────────
async function searchConvos() {
  const q = document.getElementById('search-input').value.trim();
  if (!q) return;
  const el = document.getElementById('convos-body');
  const status = document.getElementById('search-status');
  el.innerHTML = '<div class="empty"><span class="spinner"></span> Searching…</div>';
  status.textContent = '';
  try {
    const d = await api(`/api/v1/search?q=${encodeURIComponent(q)}&n=10`);
    const results = d.results || [];
    status.textContent = `${results.length} conversation${results.length !== 1 ? 's' : ''}`;
    if (!results.length) {
      el.innerHTML = '<div class="empty">No results found.</div>';
      return;
    }
    let html = `<div class="section-header">Results for "${esc(q)}"</div>`;
    results.forEach(r => {
      const score = r.score != null ? (r.score * 100).toFixed(0) + '%' : '';
      const matchBadge = r.match_count > 1
        ? `<span class="badge badge-lav">${r.match_count} matches</span> `
        : '';
      const roleColor = r.role === 'user' ? 'var(--cyan)' : 'var(--yellow)';
      html += `<div class="conv-row" onclick="loadReplay('${esc(r.conversation_id || '')}')">
        <span class="conv-id">${esc((r.conversation_id || '').slice(0,16))}</span>
        <span class="conv-preview">${matchBadge}<span style="color:${roleColor};font-size:10px">${esc(r.role||'')}</span> ${esc((r.excerpt || '').slice(0,120))}</span>
        <span class="conv-meta">${fmtTs(r.timestamp)} · ${esc(r.model||'')}</span>
        <span class="conv-score">${esc(score)}</span>
      </div>`;
    });
    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = `<div class="error-box">Search failed: ${esc(e.message)}</div>`;
  }
}

async function loadReplay(convId) {
  if (!convId) return;
  const el = document.getElementById('convos-body');
  el.insertAdjacentHTML('afterbegin',
    `<div class="section-header">Replay: ${esc(convId.slice(0,16))}
       <button onclick="forkConversation('${esc(convId)}')" style="float:right;font-size:10px;padding:2px 8px">⑂ Fork</button>
     </div>
     <div id="replay-body"><div class="empty"><span class="spinner"></span> Loading replay…</div></div>`);
  try {
    const d = await api(`/api/v1/conversation/${convId}/replay`);
    if (!d.enabled) {
      document.getElementById('replay-body').innerHTML =
        `<div style="color:var(--fg-muted);font-size:11px;padding:8px 0">${esc(d.message || 'Replay disabled.')}</div>`;
      return;
    }
    let html = '';
    (d.messages || []).forEach((m, i) => {
      const routeInfo = m.routing ? ` <span class="badge badge-lav">${esc(m.routing.method||'')}</span>` : '';
      const toolInfo  = m.tools?.length ? ` <span class="badge badge-ok">tools: ${esc(m.tools.join(', '))}</span>` : '';
      html += `<div class="kv-row">
        <span class="kv-key">${esc(m.role)}</span>
        <span class="kv-val">${esc((m.content||'').slice(0,120))}${routeInfo}${toolInfo}</span>
        <button onclick="forkConversation('${esc(convId)}',${i})" style="font-size:9px;padding:1px 6px;margin-left:8px;flex-shrink:0" title="Fork from this message">⑂</button>
      </div>`;
    });
    document.getElementById('replay-body').innerHTML = html || '<div class="empty">No messages.</div>';
  } catch(e) {
    document.getElementById('replay-body').innerHTML =
      `<div class="error-box">Replay failed: ${esc(e.message)}</div>`;
  }
}

async function forkConversation(convId, branchAt) {
  const body = {};
  if (branchAt !== undefined) body.branch_at = branchAt;
  try {
    const d = await api(`/api/v1/conversation/${convId}/fork`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const label = branchAt !== undefined ? ` at message ${branchAt}` : ' (full copy)';
    const el = document.getElementById('replay-body') || document.getElementById('convos-body');
    el.insertAdjacentHTML('afterbegin',
      `<div class="error-box" style="background:#0a2a0a;border-color:var(--green);color:var(--green)">
         ⑂ Forked${label} → new conversation <code>${esc(d.new_conversation_id.slice(0,16))}</code>
         · ${d.messages_copied} messages copied
       </div>`);
  } catch(e) {
    alert('Fork failed: ' + e.message);
  }
}

// ── 4. Flight Recorder ───────────────────────────────────────────────────────
async function loadFlight() {
  const el = document.getElementById('flight-body');
  const n  = document.getElementById('flight-n').value || 20;
  el.innerHTML = '<div class="empty"><span class="spinner"></span> Loading…</div>';
  try {
    const d = await api(`/api/v1/flight-recorder?n=${n}`);
    document.getElementById('flight-updated').textContent = 'updated ' + new Date().toLocaleTimeString();
    if (!d.enabled) {
      el.innerHTML = `<div class="error-box">${esc(d.message)}</div>
        <div style="color:var(--fg-muted);font-size:11px;padding:8px">
          Enable with <code>flight_recorder.enabled: true</code> in config.yaml
        </div>`;
      return;
    }
    const records = d.records || [];
    if (!records.length) {
      el.innerHTML = '<div class="empty">No flight records yet. Send requests through BeigeBox.</div>';
      return;
    }
    let html = `<div style="color:var(--fg-muted);font-size:11px;padding:0 0 8px">${d.count} total records · showing ${records.length}</div>`;
    records.slice().reverse().forEach(r => {
      const lc = latencyClass(r.total_ms);
      html += `<div class="flight-record" id="fr-${esc(r.id)}">
        <div class="flight-header" onclick="toggleFlight('${esc(r.id)}')">
          <span class="flight-id-text">◈ ${esc(r.id)}</span>
          <span class="flight-model-text">${esc(r.model || '')}</span>
          <span style="flex:1"></span>
          <span style="color:var(--fg-muted);font-size:10px">${r.events} events</span>
          <span class="flight-total ${lc}">${r.total_ms.toFixed(0)}ms</span>
          <span style="color:var(--fg-muted);font-size:11px">▸</span>
        </div>
        <div class="flight-events" id="fre-${esc(r.id)}">
          <div class="empty"><span class="spinner"></span> Click to expand</div>
        </div>
      </div>`;
    });
    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = `<div class="error-box">Failed to load flight recorder: ${esc(e.message)}</div>`;
  }
}

async function toggleFlight(id) {
  const card = document.getElementById('fr-' + id);
  const body = document.getElementById('fre-' + id);
  if (!card) return;
  const expanding = !card.classList.contains('expanded');
  card.classList.toggle('expanded');
  if (expanding && body.querySelector('.spinner')) {
    try {
      const d = await api('/api/v1/flight-recorder/' + id);
      let html = '';
      (d.events || []).forEach(ev => {
        const det = ev.details ? Object.entries(ev.details).map(([k,v]) => `${k}=${v}`).join(' ') : '';
        html += `<div class="flight-event">
          <span class="flight-event-ms">${ev.elapsed_ms.toFixed(1)}ms</span>
          <span class="flight-event-stage">${esc(ev.stage)}</span>
          <span class="flight-event-detail">${esc(det)}</span>
        </div>`;
      });
      // Breakdown bars
      const bk = d.summary?.breakdown || {};
      if (Object.keys(bk).length) {
        html += '<hr>';
        const total = d.summary.total_ms || 1;
        Object.entries(bk).forEach(([stage, info]) => {
          const pct = info.pct;
          const lc  = latencyClass(info.ms);
          const color = lc === 'fast' ? 'var(--flight-fast)' :
                        lc === 'medium' ? 'var(--flight-medium)' :
                        lc === 'slow' ? 'var(--flight-slow)' : 'var(--flight-crit)';
          html += `<div class="flight-bar-row">
            <span class="flight-bar-label">${esc(stage)}</span>
            <div class="flight-bar-track"><div class="flight-bar-fill" style="width:${pct}%;background:${color}"></div></div>
            <span class="flight-bar-ms">${info.ms.toFixed(0)}ms (${pct}%)</span>
          </div>`;
        });
      }
      body.innerHTML = html || '<div class="empty">No events.</div>';
    } catch(e) {
      body.innerHTML = `<div class="error-box">${esc(e.message)}</div>`;
    }
  }
}

// ── 5. Tap ────────────────────────────────────────────────────────────────────

let _tapLiveTimer = null;

const TAP_ROLE_COLOR = {
  user:      'var(--cyan)',
  assistant: 'var(--yellow)',
  system:    'var(--fg-muted)',
  decision:  'var(--lavender)',
  tool:      'var(--green)',
  error:     'var(--red)',
};
const TAP_DIR_ARROW = { inbound: '──▶', outbound: '◀──', internal: '─●─' };
const TAP_ROLE_ICON = { user:'▶', assistant:'◀', system:'●', decision:'⚖', tool:'⚡', error:'✗' };

function _renderTapEntry(e) {
  const ts    = e.ts ? new Date(e.ts).toLocaleTimeString() : '?';
  const role  = e.role || '?';
  const dir   = e.dir  || '?';
  const model = e.model || '';
  const conv  = e.conv  || '';
  const content = e.content || '';
  const len   = e.len  || 0;

  const color = TAP_ROLE_COLOR[role] || 'var(--fg)';
  const arrow = TAP_DIR_ARROW[dir]   || '───';
  const icon  = TAP_ROLE_ICON[role]  || '?';

  const modelPart = model ? ` <span style="color:var(--lavender)">[${esc(model)}]</span>` : '';
  const convPart  = conv  ? ` <span style="color:var(--fg-muted)">conv:${esc(conv.slice(0,12))}</span>` : '';
  const lenPart   = ` <span style="color:var(--fg-muted)">(${len}c)</span>`;

  const preview = content.length > 300 ? content.slice(0, 300) + '…' : content;
  const contentLines = esc(preview).replace(/\n/g, '<br>    ');

  return `<div style="margin-bottom:6px;border-bottom:1px solid var(--bg-border);padding-bottom:5px">
    <span style="color:var(--fg-muted)">${esc(ts)}</span>
    <span style="color:var(--fg-dim)">${esc(arrow)}</span>
    <span style="color:${color};font-weight:500">${esc(icon)} ${esc(role.toUpperCase())}</span>
    ${modelPart}${lenPart}${convPart}
    <div style="margin-top:3px;padding-left:16px;color:var(--fg-dim)">${contentLines}</div>
  </div>`;
}

async function loadTap() {
  const el   = document.getElementById('tap-body');
  const role = document.getElementById('tap-role').value;
  const dir  = document.getElementById('tap-dir').value;
  const n    = parseInt(document.getElementById('tap-n').value) || 50;

  // Persist filters
  try {
    localStorage.setItem('bb_tap_role', role);
    localStorage.setItem('bb_tap_dir', dir);
    localStorage.setItem('bb_tap_n', String(n));
  } catch {}

  el.innerHTML = '<div class="empty"><span class="spinner"></span> Loading…</div>';
  try {
    let url = `/api/v1/tap?n=${n}`;
    if (role) url += `&role=${encodeURIComponent(role)}`;
    if (dir)  url += `&dir=${encodeURIComponent(dir)}`;
    const d = await api(url);

    document.getElementById('tap-updated').textContent = 'updated ' + new Date().toLocaleTimeString();

    if (!d.entries || !d.entries.length) {
      el.innerHTML = '<div class="empty">No wire entries yet. Send a request through BeigeBox.</div>';
      return;
    }

    const html = d.entries.slice().reverse().map(_renderTapEntry).join('');
    el.innerHTML = `<div style="color:var(--fg-muted);font-size:10px;padding-bottom:8px">${d.total} total · showing ${d.entries.length}${role ? ' · role=' + esc(role) : ''}${dir ? ' · dir=' + esc(dir) : ''}</div>` + html;
  } catch(e) {
    el.innerHTML = `<div class="error-box">Tap failed: ${esc(e.message)}</div>`;
  }
}

function toggleTapLive() {
  const live = document.getElementById('tap-live').checked;
  if (live) {
    loadTap();
    _tapLiveTimer = setInterval(loadTap, 2000);
  } else {
    clearInterval(_tapLiveTimer);
    _tapLiveTimer = null;
  }
}

// ── 6. Operator ───────────────────────────────────────────────────────────────
async function runOp() {
  const input = document.getElementById('op-input');
  const query = input.value.trim();
  if (!query) return;
  input.value = '';

  const log = document.getElementById('op-log');
  const btn = document.getElementById('op-btn');
  btn.disabled = true;

  log.insertAdjacentHTML('beforeend',
    `<div class="op-query">▶ ${esc(query)}</div>
     <div class="op-pending" id="op-pending">⟳ operator thinking…</div>`);
  log.scrollTop = log.scrollHeight;

  try {
    const d = await api('/api/v1/operator', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query }),
    });
    document.getElementById('op-pending')?.remove();
    if (d.success) {
      log.insertAdjacentHTML('beforeend',
        `<div class="op-answer">${esc(d.answer)}</div><div class="op-sep"></div>`);
    } else {
      log.insertAdjacentHTML('beforeend',
        `<div class="op-error">✗ ${esc(d.error || 'unknown error')}</div><div class="op-sep"></div>`);
    }
  } catch(e) {
    document.getElementById('op-pending')?.remove();
    log.insertAdjacentHTML('beforeend',
      `<div class="op-error">✗ ${esc(e.message)}</div><div class="op-sep"></div>`);
  }

  btn.disabled = false;
  log.scrollTop = log.scrollHeight;
  input.focus();
}

function clearOp() {
  document.getElementById('op-log').innerHTML = '';
}

// ── 7. Config ─────────────────────────────────────────────────────────────────
function cfgInput(id, label, value, type='text') {
  return `<div class="kv-row" style="gap:12px;align-items:center">
    <span class="kv-key" style="min-width:160px">${esc(label)}</span>
    <input id="cfg-${id}" type="${type}" value="${esc(String(value ?? ''))}"
      style="flex:1;min-width:0;max-width:360px;height:26px;padding:2px 6px;font-size:12px">
  </div>`;
}
function cfgToggle(id, label, checked) {
  return `<div class="kv-row" style="gap:12px;align-items:center">
    <span class="kv-key" style="min-width:160px">${esc(label)}</span>
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
      <input id="cfg-${id}" type="checkbox" ${checked ? 'checked' : ''}
        style="width:14px;height:14px;cursor:pointer">
      <span id="cfg-${id}-lbl" style="font-size:11px;color:var(--fg-dim)">${checked ? 'enabled' : 'disabled'}</span>
    </label>
  </div>`;
}
function cfgSelect(id, label, value, options) {
  const opts = options.map(o => `<option value="${esc(o)}" ${o===value?'selected':''}>${esc(o)}</option>`).join('');
  return `<div class="kv-row" style="gap:12px;align-items:center">
    <span class="kv-key" style="min-width:160px">${esc(label)}</span>
    <select id="cfg-${id}" style="height:26px;padding:2px 6px;font-size:12px;min-width:160px">${opts}</select>
  </div>`;
}

async function loadConfig() {
  const el = document.getElementById('config-body');
  el.innerHTML = '<div class="empty"><span class="spinner"></span> Loading…</div>';
  try {
    const [cfg, tools, status] = await Promise.allSettled([
      api('/api/v1/config'),
      api('/api/v1/tools'),
      api('/api/v1/status'),
    ]);

    const c = cfg.status === 'fulfilled' ? cfg.value : {};
    const t = tools.status === 'fulfilled' ? tools.value : {};
    const s = status.status === 'fulfilled' ? status.value : {};

    let html = '';

    // ── Read-only system info ──
    html += '<div class="section-header">System (read-only)</div>';
    html += kv('backend url',   esc(c.backend?.url || '—'));
    html += kv('server',        `${esc(c.server?.host || '0.0.0.0')}:${c.server?.port || 8000}`);
    html += kv('embedding',     esc(c.embedding?.model || '—'));
    html += kv('operator model',esc(s.operator?.model || c.backend?.default_model || '—'));
    html += kv('operator shell',badge(s.operator?.shell_enabled));
    html += kv('model advertising', esc(c.model_advertising?.mode || '—'));
    const toolList = (t.tools || []);
    if (toolList.length) html += kv('tools registered', toolList.map(n=>`<span class="badge badge-ok">${esc(n)}</span>`).join(' '));

    // ── Editable settings ──
    html += '<div class="section-header" style="margin-top:16px">Settings (editable)</div>';
    html += cfgInput('default_model',       'Default model',         c.backend?.default_model || '');
    html += cfgToggle('decision_llm_enabled','Decision LLM',          c.decision_llm?.enabled ?? false);
    if (c.decision_llm?.model) html += kv('decision model', esc(c.decision_llm.model));
    html += cfgToggle('tools_enabled',       'Tools',                 t.enabled ?? c.tools?.enabled ?? false);
    html += cfgToggle('log_conversations',   'Log conversations',      c.storage?.log_conversations ?? true);
    html += cfgSelect('web_ui_palette',      'Palette theme',          c.web_ui?.palette || 'default',
                      ['default','phosphor','cobalt','sakura','slate']);
    html += cfgToggle('web_ui_vi_mode',      'Vi mode',               c.web_ui?.vi_mode ?? false);

    html += `<div style="margin-top:16px;display:flex;gap:8px;align-items:center">
      <button class="primary" onclick="saveConfig()">💾 Save &amp; Apply</button>
      <button onclick="buildCentroids()" id="centroids-btn" style="margin-left:8px">⚙ Build Centroids</button>
      <span id="cfg-save-status" style="font-size:11px;color:var(--fg-dim)"></span>
    </div>`;

    document.getElementById('config-updated').textContent = 'updated ' + new Date().toLocaleTimeString();
    el.innerHTML = html;

    // Wire up toggle labels
    ['decision_llm_enabled','tools_enabled','log_conversations','web_ui_vi_mode'].forEach(id => {
      const cb = document.getElementById(`cfg-${id}`);
      const lbl = document.getElementById(`cfg-${id}-lbl`);
      if (cb && lbl) cb.addEventListener('change', () => { lbl.textContent = cb.checked ? 'enabled' : 'disabled'; });
    });

  } catch(e) {
    el.innerHTML = `<div class="error-box">Failed to load config: ${esc(e.message)}</div>`;
  }
}

async function saveConfig() {
  const status = document.getElementById('cfg-save-status');
  if (status) status.textContent = 'saving…';

  const payload = {};
  const fields = {
    'default_model':        () => document.getElementById('cfg-default_model')?.value ?? null,
    'decision_llm_enabled': () => document.getElementById('cfg-decision_llm_enabled')?.checked ?? null,
    'tools_enabled':        () => document.getElementById('cfg-tools_enabled')?.checked ?? null,
    'log_conversations':    () => document.getElementById('cfg-log_conversations')?.checked ?? null,
    'web_ui_palette':       () => document.getElementById('cfg-web_ui_palette')?.value ?? null,
    'web_ui_vi_mode':       () => document.getElementById('cfg-web_ui_vi_mode')?.checked ?? null,
  };
  for (const [key, fn] of Object.entries(fields)) {
    const val = fn();
    if (val !== null) payload[key] = val;
  }

  try {
    const d = await api('/api/v1/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    // Apply palette and vi mode immediately without page reload
    if ('web_ui_palette' in payload) applyPalette(payload.web_ui_palette);
    if ('web_ui_vi_mode' in payload) {
      setViToggleState(payload.web_ui_vi_mode);
      if (payload.web_ui_vi_mode) injectViMode(); else removeViMode?.();
    }

    if (status) status.textContent = `✓ saved ${d.saved?.join(', ') || ''}`;
    setTimeout(() => { if (status) status.textContent = ''; }, 3000);
  } catch(e) {
    if (status) status.textContent = `✗ ${esc(e.message)}`;
  }
}


async function buildCentroids() {
  const btn = document.getElementById('centroids-btn');
  const status = document.getElementById('cfg-save-status');
  if (btn) btn.disabled = true;
  if (status) status.textContent = '⚙ Building centroids… (may take 10-30s)';
  try {
    const d = await api('/api/v1/build-centroids', { method: 'POST' });
    if (status) status.textContent = d.success ? '✓ Centroids built' : `✗ ${d.error}`;
  } catch(e) {
    if (status) status.textContent = `✗ ${esc(e.message)}`;
  } finally {
    if (btn) btn.disabled = false;
    setTimeout(() => { if (status) status.textContent = ''; }, 5000);
  }
}

loadDashboard();
loadModels();

// Restore tap filters from localStorage
try {
  const savedRole = localStorage.getItem('bb_tap_role');
  const savedDir  = localStorage.getItem('bb_tap_dir');
  const savedN    = localStorage.getItem('bb_tap_n');
  if (savedRole !== null) document.getElementById('tap-role').value = savedRole;
  if (savedDir  !== null) document.getElementById('tap-dir').value  = savedDir;
  if (savedN    !== null) document.getElementById('tap-n').value    = savedN;
} catch {}

// Restore chat history from localStorage
restoreChatHistory();
if (chatHistory.length > 0) {
  const msgDiv = document.getElementById('chat-messages');
  chatHistory.forEach(m => appendMsg(m.role, m.content, m.role === 'assistant' ? 'restored' : ''));
  setTimeout(() => { msgDiv.scrollTop = msgDiv.scrollHeight; }, 50);
}

// Bootstrap vi mode and palette from runtime config in a single fetch
(async function initWebUi() {
  try {
    const d = await api('/api/v1/config');

    // Vi mode
    const viEnabled = d.web_ui?.vi_mode === true;
    setViToggleState(viEnabled);
    if (viEnabled) injectViMode();

    // Palette
    const palette = d.web_ui?.palette || 'default';
    if (palette !== 'default') applyPalette(palette);
  } catch {}
})();
</script>
</body>
</html>
